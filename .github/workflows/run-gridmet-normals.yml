name: Run gridMET Normals

# Only trigger manually - not on GitHub-hosted runners
on:
  workflow_dispatch:

jobs:
  run-normals:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH
      
      - name: Install dependencies with Homebrew
        run: |
          brew install r
          brew install gdal
          brew install geos
          brew install proj
          brew install netcdf
          brew install udunits
          brew install rclone
      
      - name: Install pak
        run: |
          R -e "install.packages('pak', repos = sprintf('https://r-lib.github.io/p/pak/stable/%s/%s/%s', .Platform\$pkgType, R.Version()\$os, R.Version()\$arch))"
      
      - name: Install R packages
        run: |
          R -e "pak::pak(c('tidyverse', 'sf?source', 'terra?source', 'digest', 'furrr', 'future.mirai', 'mirai', 'carrier'))"
          R -e "pak::pak('mt-climate-office/normals')"
      
      - name: Create data directory
        run: |
          mkdir -p data/gridmet/daily
      
      - name: Set timezone
        run: |
          sudo timedatectl set-timezone America/Denver
      
      - name: Run gridMET normals processing
        run: |
          Rscript gridmet-normals.r
        env:
          TZ: America/Denver
      
      - name: Upload data artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gridmet-normals-data
          path: data/
          retention-days: 30
